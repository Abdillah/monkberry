#!/usr/bin/env node
var fs = require('fs');
var path = require('path');
var program = require('commander');
var Monkberry = require('../lib/index.js');

program
  .usage('[options] <file ...>')
  .option('-o, --output [file]', 'output file name, if not specified will write to stdout.')
  .option('-w, --whitespace', 'keep whitespaces')
  .parse(process.argv);

var compiler = null;

program.args.forEach(function (file) {
  var name = path.parse(file).name;
  var text = fs.readFileSync(file, {encoding: 'utf8'});
  Monkberry(name, text, {
    normalizeWhitespace: program.whitespace ? false : true
  }, function (forFile) {
    if (compiler) {
      compiler.subTemplates.push(forFile);
    } else {
      compiler = forFile;
    }
  });
});

if (compiler) {
  var code = compiler.compile();
  if (program.output) {
    fs.writeFileSync(program.output, code, {encoding: 'utf8'});
  } else {
    console.log(code);
  }
} else {
  program.outputHelp();
}
